# MongoDB Write Operations - URL Shortener

## Visual Sequence Diagram

```
┌─────────┐    ┌─────────────┐    ┌──────────┐    ┌─────────────┐    ┌─────────────┐
│ Client  │    │ Express     │    │ LRU      │    │ MongoDB     │    │ Collections │
│         │    │ Server      │    │ Cache    │    │ Atlas       │    │             │
└────┬────┘    └──────┬──────┘    └────┬────┘    └──────┬──────┘    └──────┬──────┘
     │                │                 │                │                  │
     │                │                 │                │                  │
     │ 1. POST /api/create              │                │                  │
     ├─────────────────────────────────►│                │                  │
     │                │                 │                │                  │
     │                │ 2. Check if URL exists           │                  │
     │                ├─────────────────────────────────►│                  │
     │                │                 │                │                  │
     │                │ 3. Url.findOne({longUrl})       │                  │
     │                │◄─────────────────────────────────┤                  │
     │                │                 │                │                  │
     │                │                 │                │                  │
     │                │ 4. Generate unique shortUrl      │                  │
     │                │                 │                │                  │
     │                │ 5. Generate QR Code              │                  │
     │                │                 │                │                  │
     │                │ 6. Save new URL                  │                  │
     │                ├─────────────────────────────────►│                  │
     │                │                 │                │                  │
     │                │ 7. new Url().save()              │                  │
     │                │◄─────────────────────────────────┤                  │
     │                │                 │                │                  │
     │                │ 8. Add to cache                  │                  │
     │                ├─────────────────►│                │                  │
     │                │                 │                │                  │
     │                │ 9. Return response               │                  │
     │◄─────────────────────────────────┤                │                  │
     │                │                 │                │                  │
     │                │                 │                │                  │
     │ 10. GET /:shortUrl               │                │                  │
     ├─────────────────────────────────►│                │                  │
     │                │                 │                │                  │
     │                │ 11. Check cache                  │                  │
     │                ├─────────────────►│                │                  │
     │                │◄─────────────────┤                │                  │
     │                │                 │                │                  │
     │                │ 12. If not cached, query DB      │                  │
     │                ├─────────────────────────────────►│                  │
     │                │                 │                │                  │
     │                │ 13. Url.findOne({shortUrl})     │                  │
     │                │◄─────────────────────────────────┤                  │
     │                │                 │                │                  │
     │                │ 14. Save analytics record        │                  │
     │                ├─────────────────────────────────►│                  │
     │                │                 │                │                  │
     │                │ 15. new Analytics().save()      │                  │
     │                │◄─────────────────────────────────┤                  │
     │                │                 │                │                  │
     │                │ 16. Update click count           │                  │
     │                ├─────────────────────────────────►│                  │
     │                │                 │                │                  │
     │                │ 17. Url.updateOne()              │                  │
     │                │◄─────────────────────────────────┤                  │
     │                │                 │                │                  │
     │                │ 18. Update cache                 │                  │
     │                ├─────────────────►│                │                  │
     │                │                 │                │                  │
     │                │ 19. 301 Redirect                 │                  │
     │◄─────────────────────────────────┤                │                  │
```

## Database Collections Structure

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           MongoDB Atlas Database                            │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌─────────────────────┐              ┌─────────────────────────────────┐   │
│  │     URL Collection  │              │     Analytics Collection        │   │
│  │                     │              │                                 │   │
│  │ ┌─────────────────┐ │              │ ┌─────────────────────────────┐ │   │
│  │ │ shortUrl: String│ │              │ │ shortUrl: String            │ │   │
│  │ │ longUrl: String │ │              │ │ timestamp: Date             │ │   │
│  │ │ createdAt: Date │ │              │ │ ip: String                  │ │   │
│  │ │ clickCount: Num │ │              │ │ userAgent: String           │ │   │
│  │ │ lastAccessed:   │ │              │ │ redirectTime: Number        │ │   │
│  │ │   Date          │ │              │ └─────────────────────────────┘ │   │
│  │ │ qrCode: String  │ │              │                                 │   │
│  │ └─────────────────┘ │              │                                 │   │
│  └─────────────────────┘              └─────────────────────────────────┘   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

## Write Operations Flow

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           WRITE OPERATIONS                                 │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌─────────────────┐                                                       │
│  │ 1. URL CREATION │                                                       │
│  │                 │                                                       │
│  │ POST /api/create                                                       │
│  │ ┌─────────────┐                                                         │
│  │ │ Url.save()  │ ──► Creates new URL document                           │
│  │ └─────────────┘                                                         │
│  │                                                                         │
│  │ Data Written:                                                           │
│  │ • shortUrl (8-char nanoid)                                             │
│  │ • longUrl (original URL)                                               │
│  │ • qrCode (base64 QR image)                                             │
│  │ • createdAt (timestamp)                                                │
│  └─────────────────┘                                                       │
│                                                                             │
│  ┌─────────────────┐                                                       │
│  │ 2. URL REDIRECT │                                                       │
│  │                 │                                                       │
│  │ GET /:shortUrl                                                         │
│  │ ┌─────────────────┐  ┌─────────────────┐                               │
│  │ │ Analytics.save()│  │ Url.updateOne() │                               │
│  │ └─────────────────┘  └─────────────────┘                               │
│  │                                                                         │
│  │ Analytics Data:                    URL Update:                          │
│  │ • shortUrl                          • clickCount++                     │
│  │ • timestamp                         • lastAccessed = now               │
│  │ • ip address                                                           │
│  │ • userAgent                                                             │
│  │ • redirectTime                                                          │
│  └─────────────────┘                                                       │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

## Performance & Caching Layer

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           CACHING STRATEGY                                 │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  Express Server ──► LRU Cache ──► MongoDB Atlas                            │
│       │                   │              │                                 │
│       │                   │              │                                 │
│       │ 1. Check Cache    │              │                                 │
│       ├──────────────────►│              │                                 │
│       │                   │              │                                 │
│       │ 2. Cache Hit?     │              │                                 │
│       │◄──────────────────┤              │                                 │
│       │                   │              │                                 │
│       │ 3. If Miss:       │              │                                 │
│       │    Query DB       │              │                                 │
│       ├─────────────────────────────────►│                                 │
│       │                   │              │                                 │
│       │ 4. Store in Cache │              │                                 │
│       ├──────────────────►│              │                                 │
│       │                   │              │                                 │
│                                                                             │
│  Cache Configuration:                                                       │
│  • Max Size: 1000 URLs                                                     │
│  • TTL: 1 hour                                                             │
│  • Eviction: LRU (Least Recently Used)                                     │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```
